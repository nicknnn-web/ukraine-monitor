<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乌克兰局势监控 | Ukraine Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { 
            background-color: #0a0e27; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
        }
        #map { height: 450px; border-radius: 12px; }
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }
        .pulse { 
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { opacity: .8; box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }
        .news-item { 
            border-left: 3px solid #3b82f6; 
            padding-left: 16px; 
            margin-bottom: 16px; 
            animation: slideIn 0.4s ease-out;
            transition: all 0.2s;
        }
        .news-item:hover {
            border-left-color: #60a5fa;
            transform: translateX(4px);
        }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateX(-20px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        .loading { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(59, 130, 246, 0.3); 
            border-radius: 50%; 
            border-top-color: #3b82f6; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .source-badge { 
            font-size: 10px; 
            padding: 3px 8px; 
            border-radius: 12px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6">
    <!-- 顶部导航 -->
    <div class="max-w-7xl mx-auto mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div class="flex items-center gap-4">
            <div class="relative">
                <div class="w-4 h-4 bg-red-500 rounded-full pulse"></div>
                <div class="absolute inset-0 w-4 h-4 bg-red-500 rounded-full animate-ping opacity-75"></div>
            </div>
            <div>
                <h1 class="text-3xl font-bold tracking-tight">
                    UKRAINE<span class="gradient-text">MONITOR</span>
                </h1>
                <p class="text-xs text-slate-400 mt-1">实时开源情报监控平台</p>
            </div>
        </div>
        
        <div class="flex flex-wrap items-center gap-3">
            <div class="glass px-4 py-2 rounded-lg flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span class="text-sm font-medium text-slate-300" id="api-status">API正常</span>
            </div>
            <div class="glass px-4 py-2 rounded-lg text-sm text-slate-400 font-mono" id="clock">--:--:--</div>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        <div class="glass stat-card rounded-xl p-5">
            <div class="text-3xl font-bold text-blue-400 mb-1" id="conflict-days">--</div>
            <div class="text-xs text-slate-400 uppercase tracking-wider">冲突天数</div>
            <div class="text-xs text-slate-500 mt-2">自2022年2月24日</div>
        </div>
        <div class="glass stat-card rounded-xl p-5">
            <div class="text-3xl font-bold text-amber-400 mb-1" id="event-count">--</div>
            <div class="text-xs text-slate-400 uppercase tracking-wider">今日事件</div>
            <div class="text-xs text-emerald-400 mt-2 flex items-center gap-1">
                <span>↑</span> 实时更新
            </div>
        </div>
        <div class="glass stat-card rounded-xl p-5">
            <div class="text-3xl font-bold text-purple-400 mb-1" id="source-count">1</div>
            <div class="text-xs text-slate-400 uppercase tracking-wider">数据源</div>
            <div class="text-xs text-slate-500 mt-2">NewsAPI.org</div>
        </div>
        <div class="glass stat-card rounded-xl p-5">
            <div class="text-3xl font-bold text-emerald-400 mb-1" id="update-time">--:--</div>
            <div class="text-xs text-slate-400 uppercase tracking-wider">最后更新</div>
            <div class="text-xs text-slate-500 mt-2">UTC+8</div>
        </div>
    </div>

    <!-- 主要内容区 -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- 左侧：地图和控制 -->
        <div class="lg:col-span-2 space-y-6">
            <!-- 地图 -->
            <div class="glass rounded-xl p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2 text-slate-200">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 7m0 13V7"></path>
                        </svg>
                        态势地图
                    </h2>
                    <div class="flex gap-2">
                        <span class="px-2 py-1 bg-red-500/20 text-red-400 text-xs rounded border border-red-500/30">高冲突</span>
                        <span class="px-2 py-1 bg-amber-500/20 text-amber-400 text-xs rounded border border-amber-500/30">中风险</span>
                        <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded border border-blue-500/30">稳定</span>
                    </div>
                </div>
                <div id="map" class="shadow-2xl"></div>
            </div>

            <!-- 控制面板 -->
            <div class="glass rounded-xl p-5">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4">数据控制</h3>
                <div class="flex flex-wrap gap-3">
                    <button onclick="refreshData()" class="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition text-sm font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        刷新数据
                    </button>
                    <button onclick="exportData('csv')" class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg transition text-sm font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        导出CSV
                    </button>
                    <button onclick="exportData('json')" class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 rounded-lg transition text-sm font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        导出JSON
                    </button>
                    <button onclick="testApiKey()" class="flex items-center gap-2 px-4 py-2 bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-400 border border-emerald-500/30 rounded-lg transition text-sm font-medium">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        测试API
                    </button>
                </div>
                <div class="mt-4 p-3 bg-slate-800/50 rounded-lg border border-slate-700">
                    <div class="flex items-center gap-2 text-xs text-slate-400 mb-2">
                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        API配置状态
                    </div>
                    <div id="api-config-display" class="text-xs font-mono text-slate-300 break-all">
                        正在检查...
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧：新闻流 -->
        <div class="glass rounded-xl p-5 h-fit">
            <div class="flex justify-between items-center mb-5 pb-4 border-b border-slate-700">
                <h2 class="text-lg font-bold flex items-center gap-2 text-slate-200">
                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    实时情报流
                </h2>
                <div class="loading" id="news-loading"></div>
            </div>
            
            <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                <button onclick="filterNews('all')" class="filter-btn active px-3 py-1.5 bg-blue-600 text-white text-xs rounded-full transition whitespace-nowrap" data-filter="all">全部</button>
                <button onclick="filterNews('conflict')" class="filter-btn px-3 py-1.5 bg-slate-700 text-slate-300 text-xs rounded-full transition whitespace-nowrap hover:bg-slate-600" data-filter="conflict">冲突</button>
                <button onclick="filterNews('politics')" class="filter-btn px-3 py-1.5 bg-slate-700 text-slate-300 text-xs rounded-full transition whitespace-nowrap hover:bg-slate-600" data-filter="politics">政治</button>
                <button onclick="filterNews('humanitarian')" class="filter-btn px-3 py-1.5 bg-slate-700 text-slate-300 text-xs rounded-full transition whitespace-nowrap hover:bg-slate-600" data-filter="humanitarian">人道</button>
            </div>

            <div id="news-feed" class="space-y-4 max-h-[600px] overflow-y-auto pr-2">
                <div class="text-slate-500 text-sm text-center py-12 flex flex-col items-center gap-3">
                    <div class="loading w-8 h-8 border-2"></div>
                    <p>正在连接NewsAPI...</p>
                    <p class="text-xs text-slate-600">首次加载可能需要3-5秒</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-slate-700 text-center">
                <button onclick="loadMoreNews()" class="text-sm text-blue-400 hover:text-blue-300 transition flex items-center justify-center gap-1 w-full">
                    加载更多历史数据
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <div class="max-w-7xl mx-auto mt-8 text-center text-xs text-slate-600 pb-8">
        <p>数据来源: NewsAPI.org | 地图: OpenStreetMap + CARTO | 仅供学习研究使用</p>
        <p class="mt-1">最后数据更新: <span id="footer-update">--</span></p>
    </div>

    <script>
        // ==================== 配置区域 ====================
        // ！！！重要：在这里填入你的NewsAPI密钥！！！
        // 获取地址: https://newsapi.org/register (免费，每月100次请求)
        const NEWS_API_KEY = 'YOUR_API_KEY_HERE'; // 把这里替换成你的API Key
        
        // 备用关键词（用于分类）
        const KEYWORDS = {
            conflict: ['war', 'attack', 'missile', 'bomb', 'fight', 'battle', 'strike', 'invasion', 'military', '冲突', '战争', '袭击', '导弹', '轰炸'],
            politics: ['sanction', 'diplomatic', 'peace', 'negotiation', 'NATO', 'EU', 'political', '外交', '制裁', '和平', '谈判', '北约', '欧盟'],
            humanitarian: ['aid', 'refugee', 'civilian', 'humanitarian', 'rescue', 'medical', 'food', '人道', '援助', '难民', '平民', '救援', '医疗']
        };

        // ==================== 全局状态 ====================
        let allNews = [];
        let currentFilter = 'all';
        let map;
        let newsMarkers = [];

        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', () => {
            initClock();
            initMap();
            checkApiConfig();
            loadNewsData();
            
            // 每30分钟自动刷新
            setInterval(loadNewsData, 1800000);
        });

        // 时钟
        function initClock() {
            const update = () => {
                const now = new Date();
                document.getElementById('clock').textContent = 
                    now.toLocaleTimeString('zh-CN', { hour12: false });
                document.getElementById('update-time').textContent = 
                    now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            };
            update();
            setInterval(update, 1000);

            // 冲突天数
            const start = new Date('2022-02-24');
            const days = Math.floor((new Date() - start) / (1000 * 60 * 60 * 24));
            document.getElementById('conflict-days').textContent = days;
        }

        // 地图初始化
        function initMap() {
            map = L.map('map').setView([48.5, 31.0], 6);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // 添加乌克兰主要城市
            const cities = [
                { name: '基辅 Kyiv', lat: 50.45, lng: 30.52, risk: 'medium', type: 'capital' },
                { name: '哈尔科夫 Kharkiv', lat: 49.99, lng: 36.23, risk: 'high', type: 'warzone' },
                { name: '顿涅茨克 Donetsk', lat: 48.02, lng: 37.80, risk: 'high', type: 'warzone' },
                { name: '敖德萨 Odesa', lat: 46.48, lng: 30.72, risk: 'medium', type: 'port' },
                { name: '利沃夫 Lviv', lat: 49.84, lng: 24.03, risk: 'low', type: 'west' },
                { name: '赫尔松 Kherson', lat: 46.64, lng: 32.62, risk: 'high', type: 'warzone' },
                { name: '第聂伯罗 Dnipro', lat: 48.46, lng: 35.05, risk: 'high', type: 'industrial' },
                { name: '扎波罗热 Zaporizhzhia', lat: 47.85, lng: 35.12, risk: 'high', type: 'nuclear' },
                { name: '马里乌波尔 Mariupol', lat: 47.10, lng: 37.55, risk: 'high', type: 'destroyed' }
            ];

            cities.forEach(city => {
                const color = city.risk === 'high' ? '#ef4444' : city.risk === 'medium' ? '#f59e0b' : '#3b82f6';
                const radius = city.type === 'capital' ? 10 : 8;
                
                // 主标记
                L.circleMarker([city.lat, city.lng], {
                    radius: radius,
                    fillColor: color,
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9
                }).addTo(map).bindPopup(`
                    <div style="font-family: system-ui; min-width: 150px;">
                        <h3 style="margin: 0 0 5px 0; font-size: 14px; font-weight: bold; color: #1e293b;">${city.name}</h3>
                        <p style="margin: 0; font-size: 12px; color: #64748b;">风险等级: <span style="color: ${color}; font-weight: bold; text-transform: uppercase;">${city.risk}</span></p>
                        <p style="margin: 5px 0 0 0; font-size: 11px; color: #94a3b8;">类型: ${city.type}</p>
                    </div>
                `);

                // 高风险区域添加脉冲效果
                if (city.risk === 'high') {
                    L.circle([city.lat, city.lng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.15,
                        radius: 25000
                    }).addTo(map);
                }
            });
        }

        // 检查API配置
        function checkApiConfig() {
            const display = document.getElementById('api-config-display');
            const status = document.getElementById('api-status');
            
            if (NEWS_API_KEY === 'YOUR_API_KEY_HERE' || !NEWS_API_KEY) {
                display.innerHTML = '<span class="text-red-400">⚠️ 未配置API Key</span><br>请访问 newsapi.org 获取免费API Key';
                status.textContent = '未配置';
                status.className = 'text-sm font-medium text-red-400';
                return false;
            } else {
                display.innerHTML = `<span class="text-emerald-400">✓ 已配置</span><br>Key: ${NEWS_API_KEY.substring(0, 8)}...${NEWS_API_KEY.slice(-4)}`;
                return true;
            }
        }

        // 测试API
        async function testApiKey() {
            if (!checkApiConfig()) {
                alert('请先配置NewsAPI Key！\n\n1. 访问 https://newsapi.org/register\n2. 注册获取免费API Key\n3. 将代码中的 YOUR_API_KEY_HERE 替换为你的Key');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loading w-4 h-4 border-2 mr-2"></div>测试中...';
            btn.disabled = true;

            try {
                const response = await fetch(`https://newsapi.org/v2/everything?q=ukraine&pageSize=1&apiKey=${NEWS_API_KEY}`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    alert(`✅ API连接成功！\n\n状态: ${data.status}\n总结果数: ${data.totalResults}\n账户类型: ${data.totalResults > 100 ? '付费版' : '免费版'}`);
                } else {
                    alert(`❌ API错误: ${data.message || '未知错误'}`);
                }
            } catch (error) {
                alert(`❌ 连接失败: ${error.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ==================== 新闻数据加载 ====================
        async function loadNewsData() {
            const loading = document.getElementById('news-loading');
            loading.style.display = 'inline-block';

            // 如果没有配置API Key，使用模拟数据
            if (!checkApiConfig()) {
                useMockData();
                loading.style.display = 'none';
                return;
            }

            try {
                // 使用NewsAPI获取乌克兰相关新闻（过去7天）
                const fromDate = new Date();
                fromDate.setDate(fromDate.getDate() - 7);
                const fromStr = fromDate.toISOString().split('T')[0];

                const url = `https://newsapi.org/v2/everything?q=ukraine+war+OR+russia+conflict&from=${fromStr}&sortBy=publishedAt&language=en&pageSize=20&apiKey=${NEWS_API_KEY}`;
                
                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'ok' && data.articles) {
                    allNews = data.articles.map(article => ({
                        id: Date.now() + Math.random(),
                        title: article.title,
                        content: article.description || '暂无摘要',
                        source: article.source.name,
                        author: article.author,
                        url: article.url,
                        image: article.urlToImage,
                        publishedAt: new Date(article.publishedAt),
                        time: new Date(article.publishedAt).toLocaleString('zh-CN', { 
                            month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' 
                        }),
                        category: categorizeNews(article.title + ' ' + (article.description || '')),
                        location: extractLocation(article.title + ' ' + (article.description || ''))
                    }));

                    updateDisplay();
                    document.getElementById('api-status').textContent = '在线';
                    document.getElementById('api-status').className = 'text-sm font-medium text-emerald-400';
                } else {
                    throw new Error(data.message || 'API返回错误');
                }
            } catch (error) {
                console.error('NewsAPI Error:', error);
                document.getElementById('api-status').textContent = '错误';
                document.getElementById('api-status').className = 'text-sm font-medium text-red-400';
                useMockData();
            } finally {
                loading.style.display = 'none';
                document.getElementById('footer-update').textContent = new Date().toLocaleString('zh-CN');
            }
        }

        // 新闻分类
        function categorizeNews(text) {
            const lower = text.toLowerCase();
            if (KEYWORDS.conflict.some(k => lower.includes(k.toLowerCase()))) return 'conflict';
            if (KEYWORDS.politics.some(k => lower.includes(k.toLowerCase()))) return 'politics';
            if (KEYWORDS.humanitarian.some(k => lower.includes(k.toLowerCase()))) return 'humanitarian';
            return 'general';
        }

        // 提取地点（简化版）
        function extractLocation(text) {
            const locations = ['Kyiv', 'Kiev', 'Kharkiv', 'Donetsk', 'Odesa', 'Lviv', 'Kherson', 'Dnipro', 'Mariupol', 'Zaporizhzhia', 'Crimea', 'Moscow', 'Washington', 'Brussels', 'London', 'Berlin', 'Paris'];
            for (let loc of locations) {
                if (text.toLowerCase().includes(loc.toLowerCase())) return loc;
            }
            return 'Ukraine';
        }

        // 使用模拟数据（当API不可用时）
        function useMockData() {
            const mockNews = [
                { title: "Ukraine-Russia War: Latest Updates on Military Operations", content: "Heavy fighting reported in eastern Ukraine as both sides exchange artillery fire...", source: "BBC News", time: "10分钟前", category: "conflict", location: "Donetsk", url: "#" },
                { title: "EU Approves New Sanctions Package Against Russia", content: "European Union leaders have agreed on a 12th package of sanctions...", source: "Reuters", time: "32分钟前", category: "politics", location: "Brussels", url: "#" },
                { title: "Humanitarian Aid Convoy Reaches Frontline Cities", content: "UN agencies deliver critical supplies to civilians trapped in conflict zones...", source: "UN News", time: "1小时前", category: "humanitarian", location: "Kherson", url: "#" },
                { title: "Zelensky Calls for More Air Defense Systems", content: "Ukrainian president urges Western allies to expedite military assistance...", source: "CNN", time: "2小时前", category: "politics", location: "Kyiv", url: "#" },
                { title: "Russia Launches Overnight Missile Attacks", content: "Multiple regions targeted in latest wave of strikes on infrastructure...", source: "Al Jazeera", time: "3小时前", category: "conflict", location: "Odesa", url: "#" },
                { title: "Refugee Crisis: Over 6 Million Displaced", content: "UNHCR reports ongoing challenges in neighboring countries hosting refugees...", source: "The Guardian", time: "4小时前", category: "humanitarian", location: "Poland", url: "#" },
                { title: "NATO Chief Visits Kyiv for Security Talks", content: "Stoltenberg reaffirms alliance commitment to Ukrainian sovereignty...", source: "Politico", time: "5小时前", category: "politics", location: "Kyiv", url: "#" }
            ];

            allNews = mockNews.map((item, idx) => ({
                ...item,
                id: Date.now() + idx,
                publishedAt: new Date(Date.now() - idx * 3600000)
            }));

            updateDisplay();
            
            // 显示提示
            const feed = document.getElementById('news-feed');
            const notice = document.createElement('div');
            notice.className = 'bg-amber-500/10 border border-amber-500/30 rounded-lg p-3 mb-4 text-xs text-amber-400';
            notice.innerHTML = '⚠️ 当前显示模拟数据。如需真实新闻，请配置NewsAPI Key。';
            feed.insertBefore(notice, feed.firstChild);
        }

        // 更新显示
        function updateDisplay() {
            displayNewsList();
            updateStats();
            addNewsToMap();
        }

        // 显示新闻列表
        function displayNewsList() {
            const feed = document.getElementById('news-feed');
            feed.innerHTML = '';

            const filtered = currentFilter === 'all' 
                ? allNews 
                : allNews.filter(n => n.category === currentFilter);

            if (filtered.length === 0) {
                feed.innerHTML = '<div class="text-slate-500 text-center py-8">该分类暂无数据</div>';
                return;
            }

            filtered.forEach(news => {
                const div = document.createElement('div');
                div.className = 'news-item cursor-pointer group';
                
                const categoryColors = {
                    conflict: 'text-red-400 bg-red-400/10 border-red-400/30',
                    politics: 'text-purple-400 bg-purple-400/10 border-purple-400/30',
                    humanitarian: 'text-emerald-400 bg-emerald-400/10 border-emerald-400/30',
                    general: 'text-blue-400 bg-blue-400/10 border-blue-400/30'
                };
                
                const catClass = categoryColors[news.category] || categoryColors.general;
                const catName = {conflict: '冲突', politics: '政治', humanitarian: '人道', general: '综合'}[news.category];

                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-slate-500 font-mono">${news.time}</span>
                        <span class="text-[10px] px-2 py-0.5 rounded border ${catClass}">${catName}</span>
                    </div>
                    <h3 class="text-sm font-semibold text-slate-200 group-hover:text-blue-400 transition line-clamp-2 mb-1">${news.title}</h3>
                    <p class="text-xs text-slate-400 line-clamp-2 mb-2">${news.content}</p>
                    <div class="flex justify-between items-center text-xs text-slate-500">
                        <span class="flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
                            ${news.source}
                        </span>
                        <span class="flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            ${news.location}
                        </span>
                    </div>
                `;

                div.onclick = () => {
                    if (news.url && news.url !== '#') {
                        window.open(news.url, '_blank');
                    }
                };

                feed.appendChild(div);
            });

            document.getElementById('event-count').textContent = allNews.length;
        }

        // 筛选新闻
        function filterNews(category) {
            currentFilter = category;
            
            // 更新按钮样式
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === category) {
                    btn.className = 'filter-btn active px-3 py-1.5 bg-blue-600 text-white text-xs rounded-full transition whitespace-nowrap';
                } else {
                    btn.className = 'filter-btn px-3 py-1.5 bg-slate-700 text-slate-300 text-xs rounded-full transition whitespace-nowrap hover:bg-slate-600';
                }
            });
            
            displayNewsList();
        }

        // 在地图上添加新闻标记
        function addNewsToMap() {
            // 清除旧标记
            newsMarkers.forEach(m => map.removeLayer(m));
            newsMarkers = [];

            // 为冲突类新闻添加标记
            const conflictNews = allNews.filter(n => n.category === 'conflict').slice(0, 5);
            
            conflictNews.forEach(news => {
                // 随机偏移，避免重叠
                const lat = 48.5 + (Math.random() - 0.5) * 4;
                const lng = 31 + (Math.random() - 0.5) * 6;
                
                const marker = L.circleMarker([lat, lng], {
                    radius: 6,
                    fillColor: '#ef4444',
                    color: '#fff',
                    weight: 2,
                    opacity: 0.8,
                    fillOpacity: 0.6
                }).addTo(map);
                
                marker.bindPopup(`
                    <div style="font-family: system-ui; max-width: 200px;">
                        <div style="font-size: 11px; color: #ef4444; font-weight: bold; margin-bottom: 4px;">[冲突] ${news.location}</div>
                        <div style="font-size: 12px; color: #1e293b; font-weight: 600; line-height: 1.3;">${news.title}</div>
                        <div style="font-size: 10px; color: #64748b; margin-top: 4px;">${news.source} · ${news.time}</div>
                    </div>
                `);
                
                newsMarkers.push(marker);
            });
        }

        // 更新统计
        function updateStats() {
            const categories = {};
            allNews.forEach(n => {
                categories[n.category] = (categories[n.category] || 0) + 1;
            });
        }

        // 刷新数据
        function refreshData() {
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<div class="loading w-4 h-4 border-2 mr-2"></div>刷新中...';
            btn.disabled = true;
            
            loadNewsData().then(() => {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            });
        }

        // 加载更多（模拟）
        function loadMoreNews() {
            const btn = event.target;
            btn.innerHTML = '<div class="loading w-4 h-4 border-2 mr-2 inline-block"></div>加载中...';
            
            setTimeout(() => {
                // 复制现有数据模拟更多内容
                const moreNews = allNews.slice(0, 5).map(n => ({
                    ...n,
                    id: Date.now() + Math.random(),
                    time: '昨天 ' + n.time.split(' ')[1]
                }));
                allNews = [...allNews, ...moreNews];
                updateDisplay();
                btn.innerHTML = '加载更多历史数据<svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>';
            }, 1000);
        }

        // ==================== 导出功能 ====================
        function exportData(format) {
            if (allNews.length === 0) {
                alert('暂无数据可导出');
                return;
            }

            const data = allNews.map(n => ({
                时间: n.time,
                标题: n.title,
                内容: n.content,
                来源: n.source,
                分类: n.category,
                地点: n.location,
                链接: n.url,
                导出时间: new Date().toLocaleString('zh-CN')
            }));

            if (format === 'csv') {
                const headers = Object.keys(data[0]);
                const csvContent = [
                    headers.join(','),
                    ...data.map(row => headers.map(h => {
                        const val = row[h] || '';
                        return `"${val.toString().replace(/"/g, '""')}"`;
                    }).join(','))
                ].join('\n');
                
                const BOM = '\uFEFF';
                downloadFile(BOM + csvContent, `ukraine_news_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
                
            } else if (format === 'json') {
                const jsonStr = JSON.stringify(data, null, 2);
                downloadFile(jsonStr, `ukraine_news_${new Date().toISOString().split('T')[0]}.json`, 'application/json');
            }
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // 显示成功提示
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-emerald-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
            toast.innerHTML = `✓ 已导出 ${filename}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>